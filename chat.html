<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat App hw10</title>
    <script type="importmap">
      {
        "imports": {
          "vue": "https://cdn.jsdelivr.net/npm/vue@3.5.13/dist/vue.esm-browser.js",
          "@graffiti-garden/implementation-local": "https://cdn.jsdelivr.net/npm/@graffiti-garden/implementation-local@0.6.4/dist/browser/index.js",
          "@graffiti-garden/implementation-remote": "https://cdn.jsdelivr.net/npm/@graffiti-garden/implementation-remote@0.6.2/dist/browser/index.js",
          "@graffiti-garden/wrapper-vue": "https://cdn.jsdelivr.net/npm/@graffiti-garden/wrapper-vue@0.7.2/dist/browser/plugin.mjs"
        }
      }
    </script>
    <link rel="stylesheet" href="styles/style.css" />
    <link rel="stylesheet" href="styles/chat.css" />
    <link rel="stylesheet" href="styles/index.css" />
  </head>
  <body>
    <div id="app">
      <header>
        <span>
          <a href="index.html">
            <img class="icon" src="assets/arrow.png" />
          </a>
          <h1>{{selectedGroupChat?.name}}</h1>
        </span>
        <button @click="$graffiti.logout($graffitiSession.value)" id="logout">Log Out</button>
      </header>
      <main id="main">
        <!-- <form @submit.prevent="uploadImage(selectedGroupChat?.channel)">
          <label>
            Image Url:
            <input type="text" />
          </label>
        </form> -->
        <h2>Messages</h2>

        <graffiti-discover
          id="messageFrame"
          v-slot="{ objects: messageObjects, isInitialPolling }"
          :channels="[selectedGroupChat?.channel]"
          :schema="{
                  properties: {
                      value: {
                          required: ['content', 'published'],
                          properties: {
                              content: { type: 'string' },
                              published: { type: 'number' }
                          }
                      }
                  }
              }"
        >
          <div id="messageFrame">
            <!-- {{messageObjects}} -->
            <p v-if="isInitialPolling">Loading...</p>
            <div
              v-for="object of messageObjects.sort((a, b) => b.value.published - a.value.published)"
              :key="object.url"
            >
              <!-- Current Actor's Message -->
              <div class="ownMessage" v-if="object.actor===$graffitiSession.value.actor">
                <!-- editing message -->
                <div class="messageContainer" v-if="object.url === messageToEdit">
                  <div class="sender">
                    <p>{{object.actor}}</p>
                  </div>
                  <div class="messageBody">
                    <div class="messageContent">
                      <input type="text" v-model="editContent" />
                    </div>
                    <div class="messageTime">
                      <time-stamp type="message" :object="object"></time-stamp>
                    </div>
                  </div>
                  <span class="controlButtons">
                    <button @click="finishEdit(object)">Submit</button>
                    <button @click="cancelEdit()">Cancel</button>
                  </span>
                </div>

                <!-- non-editing message -->
                <div v-else class="messageContainer">
                  <div class="sender">
                    <p>{{object.actor}}</p>
                  </div>
                  <div class="messageBody">
                    <div class="messageContent">
                      <p>{{object.value.content}}</p>
                    </div>
                    <div class="messageTime">
                      <time-stamp type="message" :object="object"></time-stamp>
                    </div>
                  </div>
                  <span class="controlButtons">
                    <button @click="startEdit(object)">Edit</button>
                    <button @click="deleteMessage(object)">Delete</button>
                  </span>
                </div>
              </div>

              <div v-else class="otherMessage">
                <!-- non-editing message -->
                <div class="messageContainer">
                  <div class="sender">
                    <p>{{object.actor}}</p>
                  </div>
                  <div class="messageBody">
                    <div class="messageContent">
                      <p>{{object.value.content}}</p>
                    </div>
                    <div class="messageTime">
                      <time-stamp type="message" :object="object"></time-stamp>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </graffiti-discover>
      </main>

      <footer>
        <form @submit.prevent="sendMessage($graffitiSession.value)">
          <fieldset :disabled="sending">
            <input id="messageBar" type="text" v-model="myMessage" placeholder="Message" ref="messageInput" v-focus />
            <input type="submit" :value="sending? 'Sending...' : 'Send'" />
          </fieldset>
        </form>
      </footer>
    </div>

    <script src="index.js" type="module"></script>
  </body>
</html>
